<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.green-blue.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:regular,bold,italic,thin,light,bolditalic,black,medium&lang=en">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <style>
      .mdl-action-block{ margin-top: 1em; padding-top: 10px; border-top: 1px solid rgba(0,0,0,.12); text-align: right; }
      .mdl-snackbar__action { color: white; }
      
      #filtersList > ul {
        width: 90%;
        height: 250px;
        overflow-y: scroll
      }
      #filtersColumns > ul {
        clear:both;
      }
      #filtersColumns li {
        display: inline;
      }
      .itemHighlight {
        background-color: green;
      }
    </style>
  </head>
  <body class="mdl-layout mdl-js-layout">
    <div id="filtersList">loading filters ...</div>
  
    <form id="jiraIssuesFormFilter" action="" method="post" class="mdl-layout__content">
      <input type="hidden" name="filter_id" id="filterId" value="" />
        
      <label class="mdl-textfield__label" for="jira-domain">Columns</label>
      <div id="filtersColumns"></div>

      <div class="mdl-action-block">
        <button name="buttonreset" type="button" class="mdl-button mdl-js-button" onclick="google.script.host.close()">
          <i class="material-icons">close</i> Cancel
        </button>
        <button name="buttonsubmit" type="submit" class="mdl-button mdl-js-button mdl-button--raised mdl-button--accent">
          <i class="material-icons">view_list</i> Insert
        </button>
      </div>
    </form>
    
    <div id="response-message" class="mdl-js-snackbar mdl-snackbar" role="dialog">
      <div class="mdl-snackbar__text"></div>
      <button class="mdl-snackbar__action" type="button"></button>
    </div>
    
    <script src="https://cdn.rawgit.com/google/material-design-lite/mdl-1.x/src/mdlComponentHandler.js"></script>
    <script src="https://cdn.rawgit.com/google/material-design-lite/mdl-1.x/src/layout/layout.js"></script>
    <script src="https://cdn.rawgit.com/google/material-design-lite/mdl-1.x/src/button/button.js"></script>
    <script src="https://cdn.rawgit.com/google/material-design-lite/mdl-1.x/src/textfield/textfield.js"></script>
    <script src="https://cdn.rawgit.com/google/material-design-lite/mdl-1.x/src/snackbar/snackbar.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script>
      $.fn.serializeObject = function() {
        var o = {};
        var a = this.serializeArray();
        $.each(a, function() {
          if (o[this.name]) {
            if (!o[this.name].push) {
              o[this.name] = [o[this.name]];
            }
            o[this.name].push(this.value || '');
          } else {
            o[this.name] = this.value || '';
          }
        });
        return o;
      };

      var valid  = false;
      var $form = $('#jiraIssuesFormFilter');

      var setup  = document.querySelector('form');
      var alert  = document.getElementById('response-message');
      var action = document.querySelector('[type=submit]');

      function formSubmitHandler(event) {
        if (event) event.preventDefault();

        alert.MaterialSnackbar.hideSnackbar();

        if (!valid) return;

        alert.style.backgroundColor = 'rgb(139,195,74)';
        alert.MaterialSnackbar.showSnackbar({
          message: 'inserting ...',
          timeout: 1500
        });

        google.script.run
          .withSuccessHandler(onResponse)
          .withFailureHandler(onResponse)
          .insertIssuesFromFilter($form.serializeObject());
      }

      function inputValidatyHandler() {
        var validaty = true;
        $form.find(':input').each(function(e, el){ 
          var elementValid = false;
          switch(el.type) {
            case 'button':
            case 'submit':
              elementValid = true;
            break;
            case 'checkbox':
              elementValid = ($('input[name^="columns"]:checked').length > 0);
            break;
            default:
              elementValid = (el.value.length > 0);
            break;
          }

          return validaty && (validaty = elementValid);
        });
        valid = validaty;
        action.MaterialButton[valid?'enable':'disable']();
      }

      function onResponse(response) {
        var done = response.status === true;

        alert.MaterialSnackbar.hideSnackbar();
        
        if(done) {
          google.script.host.close();
        }
        else {
          response.actionText = 'Try again.';
          response.actionHandler = function(){ setup.dispatchEvent(new Event('submit')); };
        }

        response.timeout = 10000;

        alert.style.backgroundColor = done ? 'rgb(139,195,74)' : 'rgb(213,0,0)';
        alert.MaterialSnackbar.showSnackbar(response);
      }

      function renderFiltersList(filters) {
        var filters = filters || [];
        // render list of filters to select from
        var $filterId = $('#filterId');
        var $filtersList = $('#filtersList');
        var ul = $("<ul>");

        for( var i=0; i<filters.length; i++ ) {
          var li = $('<li/>')
            .attr('data-id', filters[i].id)
            .appendTo(ul);

          $('<span/>')
            .addClass('favourite')
            .text( (filters[i].favourite ? '*' : '') )
            .appendTo(li);
          $('<span/>')
            .addClass('filterName')
            .text(filters[i].name)
            .appendTo(li);
          $('<span/>')
            .addClass('filterOwner')
            .text('( ' + filters[i].owner + ' )')
            .appendTo(li);
        }
        $filtersList.html('').append(ul);

        // bind event
        var $filterId = $('#filterId').on('change', inputValidatyHandler);
        $filtersList.find('li').on('click', function(e) {
          $('li[data-id=' + $filterId.val() + ']').toggleClass('itemHighlight');
          $filterId.val( $(this).toggleClass('itemHighlight').data("id") ).trigger('change');
        });

        $form.find(':input').each(function(e, el){ 
          el.addEventListener('change', inputValidatyHandler);
        });

        inputValidatyHandler();
      }

      $(function() {
        setup.addEventListener('submit', formSubmitHandler);

        google.script.run
          .withSuccessHandler(renderFiltersList)
          .getMyFilters(true);

        var columns = JSON.parse(<?= JSON.stringify(columns); ?>);
        var defaults = JSON.parse(<?= JSON.stringify(defaultColumns); ?>);

        // render selection of columns
        var checkboxContainer = $("#filtersColumns");
        $.each(columns, function(colId) {
          var li = $('<li/>')
            .addClass('_col')
            .appendTo(checkboxContainer);

          var input = $('<input/>')
            .addClass('_colChk')
            .attr('type', 'checkbox')
            .attr('name', 'columns[]')
            .val(colId)
            .prop('checked', (defaults.indexOf(colId) != -1) ? true : false)
            .appendTo(li);

          var sp = $('<span/>')
            .addClass('_colLabel')
            .text(columns[colId])
            .appendTo(li);
        });
      });
    </script>
  </body>
</html>