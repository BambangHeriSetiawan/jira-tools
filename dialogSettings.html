<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.green-blue.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:regular,bold,italic,thin,light,bolditalic,black,medium&lang=en">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <style>
      .mdl-action-block{ margin-top: 1em; padding-top: 10px; border-top: 1px solid rgba(0,0,0,.12); text-align: right; }
      .mdl-snackbar__action { color: white; }
    </style>
  </head>
  <body class="mdl-layout mdl-js-layout">
    <form id="jiraServerSettings" action="" method="post" class="mdl-layout__content">
      <div class="mdl-textfield mdl-js-textfield">
        <input type="text" class="mdl-textfield__input" id="jira-domain" name="jira_domain" value="<?= domain ?>">
        <label class="mdl-textfield__label" for="jira-domain">Jira Domain (YOURCOMPANY.atlassian.net)</label>
      </div>
      <div class="mdl-textfield mdl-js-textfield">
        <input type="text" class="mdl-textfield__input" id="jira-username" name="jira_username" value="<?= username ?>">
        <label class="mdl-textfield__label" for="jira-username">Username (yourname@domain.com)</label>
      </div>
      <div class="mdl-textfield mdl-js-textfield">
        <input type="password" class="mdl-textfield__input" id="jira-password" name="jira_password" value="<?= password ?>">
        <label class="mdl-textfield__label" for="jira-password">Password</label>
      </div>
      
      <div class="mdl-action-block">
        <button name="buttonreset" type="button" class="mdl-button mdl-js-button" onclick="google.script.host.close()">
          <i class="material-icons">close</i> Cancel
        </button>
        <button name="buttonsubmit" type="submit" class="mdl-button mdl-js-button mdl-button--raised mdl-button--accent" disabled>
          <i class="material-icons">save</i> Save
        </button>
      </div>
    </form>
    
    <div id="response-message" class="mdl-js-snackbar mdl-snackbar" role="dialog">
      <div class="mdl-snackbar__text"></div>
      <button class="mdl-snackbar__action" type="button"></button>
    </div>
    
    <script src="https://cdn.rawgit.com/google/material-design-lite/mdl-1.x/src/mdlComponentHandler.js"></script>
    <script src="https://cdn.rawgit.com/google/material-design-lite/mdl-1.x/src/layout/layout.js"></script>
    <script src="https://cdn.rawgit.com/google/material-design-lite/mdl-1.x/src/button/button.js"></script>
    <script src="https://cdn.rawgit.com/google/material-design-lite/mdl-1.x/src/textfield/textfield.js"></script>
    <script src="https://cdn.rawgit.com/google/material-design-lite/mdl-1.x/src/snackbar/snackbar.js"></script>
    <script>
      var valid  = false;
      var setup  = document.querySelector('form');
      var input  = Array.prototype.slice.call(setup.getElementsByTagName('input'));
      var alert  = document.getElementById('response-message');
      var action = document.querySelector('[type=submit]');

      function formSubmitHandler(event) {
        if (event) event.preventDefault();
        
        alert.MaterialSnackbar.hideSnackbar();
        
        if (!valid) return;

        alert.style.backgroundColor = 'rgb(139,195,74)';
        alert.MaterialSnackbar.showSnackbar({
          message: 'saving ...',
          timeout: 1500
        });

        google.script.run
          .withSuccessHandler(onResponse)
          .withFailureHandler(onResponse)
          .saveSettings(this);
      }
      
      function inputValidatyHandler() {
        var validaty = true;
        input.forEach(function(el){ return validaty && (validaty = el.value.length > 0); });
        valid = validaty;
        action.MaterialButton[valid?'enable':'disable']();
      }

      function onResponse(response) {
        var done = response.status === true;

        alert.MaterialSnackbar.hideSnackbar();
        
        if(done) {
          google.script.host.close();
        }
        else {
          response.actionText = 'Try again.';
          response.actionHandler = function(){ setup.dispatchEvent(new Event('submit')); };
        }
        
        response.timeout = 10000;
        
        alert.style.backgroundColor = done ? 'rgb(139,195,74)' : 'rgb(213,0,0)';
        alert.MaterialSnackbar.showSnackbar(response);
      }
      
      setup.addEventListener('submit', formSubmitHandler);
      input.forEach(function(el){ el.addEventListener('keyup', inputValidatyHandler); });
      window.addEventListener('load', inputValidatyHandler);
    </script>
  </body>
</html>