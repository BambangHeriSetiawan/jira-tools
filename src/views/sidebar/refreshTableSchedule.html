<!DOCTYPE html>
<html>
<head>
<base target="_top">
<link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/material-design-lite/1.1.0/material.min.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:400,500,700">
<style>
/* @TODO: extract into static css, assets and use S3 (see add-on logo storage */
:root {
    --docs-material-font-family: Roboto, Helvetica, Arial, sans-serif;
    --docs-material-header-font-family: var(--docs-material-font-family);
    --docs-material-font-weight-normal: 400;
    --docs-material-font-weight-bold: 500;
    --docs-material-font-size-normal: 14px;
    --docs-material-font-size-9: 9px;
    --docs-material-font-size-11: 11px;
    --docs-material-font-size-12: 12px;
    --docs-material-font-size-22: 22px;
}

html, body, html * {
	/*font-family: 'Roboto-Light', 'Roboto-Medium', 'Roboto-Bold', 'Roboto', Helvetica, Arial, sans-serif;*/
	font-family: Roboto, Helvetica, Arial, sans-serif;
	font-size: 13px;
	color: black;
	font-weight: normal;
}

a, a:active, a:visited {
	background-image: none;
	border: 1px solid transparent !important;
	border-radius: 4px;
	box-shadow: none;
	box-sizing: border-box;
	font-family: var(--docs-material-header-font-family, Roboto, Helvetica, Arial, sans-serif);
	font-weight: var(--docs-material-font-weight-bold, 500);
	font-size: 14px;
	height: 36px;
	letter-spacing: 0.25px;
	line-height: 16px;
	padding: 9px 24px 11px 24px;
	color: #188038;
	display: inline-block;
}
a.feedback-link, a.feedback-link:active, a.feedback-link:visited
{
	border-radius: 4px;
	font-family: var(--docs-material-header-font-family, Roboto, Helvetica, Arial, sans-serif);
	font-weight: var(--docs-material-font-weight-bold, 500);
	font-size: 14px;
    height: auto;
	letter-spacing: 0.25px;
    line-height: normal;
	padding: 0;
	color: #188038;
	display: inline-block;
}
.sidebar.bottom a.feedback-link {
    float: right;
}

.loader, .loader:after {
	border-radius: 50%;
	width: 5em;
	height: 5em;
}

.loader {
	margin: 60px auto;
	font-size: 10px;
	position: relative;
	text-indent: -9999em;
	border-top: .7em solid rgba(24, 158, 26, 0.2);
	border-right: .7em solid rgba(24, 158, 26, 0.2);
	border-bottom: .7em solid rgba(24, 158, 26, 0.2);
	border-left: .7em solid #189e1a;
	-webkit-transform: translateZ(0);
	-ms-transform: translateZ(0);
	transform: translateZ(0);
	-webkit-animation: load8 1.1s infinite linear;
	animation: load8 1.1s infinite linear;
}

@-webkit-keyframes load8 {
  0% {
    -webkit-transform: rotate(0deg);
    transform: rotate(0deg);
  }
  100% {
    -webkit-transform: rotate(360deg);
    transform: rotate(360deg);
  }
}
@keyframes load8 {
  0% {
    -webkit-transform: rotate(0deg);
    transform: rotate(0deg);
  }
  100% {
    -webkit-transform: rotate(360deg);
    transform: rotate(360deg);
  }
}
.sidebar {
	padding: 0;
}

.branding-below {
	bottom: 46px;
	top: 0;
}

.sidebar.bottom {
	font-size: 12px;
	padding: 12px;
}

#box-tip {
	margin: 10px;
	padding: 15px;
	background-color: #e6f4ea;
	border-radius: 8px;
	color: #188038;
}

#box-tip h4 {
	color: #188038;
	font-size: 14px;
	font-weight: 500;
	margin: 0 0 10px;
}

#box-tip p {
	color: #188038;
	font-size: 12px;
	letter-spacing: .3px;
	line-height: normal;
}


#box-tip .tip-footer {
	display: flex;
	justify-content: flex-end;
}

.issuetable {
	font-size: 13px;
	font-weight: 400;
	border-bottom: 1px solid #ddd;
	cursor: default;
	padding: 10px 20px;
	position: relative;
}

.issuetable .name {
	font-size: 14px;
	font-weight: 500;
}

.issuetable .actions {
    margin-top: 10px;
}
.issuetable .actions .action {
    /* Schedule button appears disabled, feature coming soon */
    opacity: .5
}

.issuetable .schedule-setup {
    border: 1px solid grey;
    padding: 10px;
    margin: 10px 0;
    background-color: aliceblue;
    display: none;
    font-style: italic;
}
</style>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>
<body>
  <div class="sidebar branding-below">
    <div class="loader">Loading ...</div>

    <div id="table-container"></div>

    <div id="box-tip">
      <h4>Explore Tips</h4>
      <p>
        You do not have any Jira "IssueTable" in your current sheet(s).<br />
        Menu: Add-ons > Project Aid for Jira > List issues from filter
      </p>
      <div class="tip-footer">
        <a href="https://github.com/ljay79/jira-tools/tree/master#refresh-issuetable">Read more</a>
      </div>
    </div>
  </div>

  <div class="sidebar bottom">
    <a href="#" class="feedback-link">Leave feedback</a>
    <span class="gray">Project Aid for Jira v<?= buildNumber ?></span>
  </div>

  <!-- BGN: Template of HTML elements for an individual IssueTable //-->
  <div id="table-element-template" class="issuetable" style="display: none">
    <div class="descr">
      <span class="name">Table: Filter 01 - Lorem ipsum</span><br />
      <span class="location">Tabellenblatt89!A1:F23</span><br />
      <span class="updated">Updated: &gt;<span class="time-elapsed"></span></span>
    </div>
    <div class="schedule-setup">
      Coming soon ...
    </div>
    <div class="block actions">
      <button class="share" disabled>Refresh</button>
      <button class="action" disabled>Schedule</button>
    </div>
  </div>
  <!-- END: Template //-->

  <script>
      var box_tip = $('#box-tip');
      var loading = $('.loader');
      var issueTableContainer = $('#table-container');

      var issueTableContainer = $('#table-container');
      $('a.feedback-link').each(function() {
        $(this).click(function(event){
          event.preventDefault();
          leaveFeedback();
        });
      });

      /**
       * @desc Perform callback to refresh specific IssueTable in active Sheet.
       * @param {Event} event    jQuery event, usually click on a button
       */
      function refreshTable(event) {
        var button = $(this);
        button.prop('disabled', true);

        function onResponse(response) {
          var done = response.status === true;
          if (done) {
            button.prop('disabled', false);
          }
        }

        google.script.run
          .withSuccessHandler(onResponse)
          .withFailureHandler(onResponse)
          .cbRefreshIssueTable_refreshTable(event.data);
      }

      function onReloadSidebar(response) {
        loading.removeClass('loader').hide();

        var table_element_tpl = $('#table-element-template');

        issueTableContainer.empty();
        if (response.tables.length > 0) {
          box_tip.hide();
        } else {
          box_tip.show();
        }

        response.tables.forEach(function (tableMeta) {
          var tableName = tableMeta.name;
          var tableLocation = tableMeta.sheetName + '!' + tableMeta.rangeA1;
          var updatedElapsed = tableMeta.timeElapsedFormatted || '';

          var divTable = table_element_tpl.clone().removeAttr('id');
          divTable.find('.descr > .name').html(tableName);
          divTable.find('.descr > .location').html(tableLocation);
          divTable.find('.descr > .updated > .time-elapsed').html(updatedElapsed);
          divTable.prop('data-table-id', tableMeta.tableId).prop('data-sheet-id', tableMeta.sheetId).show();

          // enable action buttons
          divTable.find('.actions > :button.share').prop('disabled', false).click(tableMeta, refreshTable);
          divTable.find('.actions > :button.action')
            .prop('disabled', false)
            .click(tableMeta, function (event) {
              var scheduleContainer = $(this).parent().parent().find('.schedule-setup').toggle();
            });

          divTable.appendTo(issueTableContainer);
        });

        window.dispatchEvent(new Event('load'));
      }

      function leaveFeedback() {
        google.script.run.cbFeedback_getDialog();
      }

      /*
       * Polling for sheet switches or change in IssueTable index of current sheet.
       */
      var pollError = 0;
      $(function () {
        poll();
      });

      /**
       * Poll every 1.5 second to check for changes
       * in which case we update the sidebar
       */
      function poll(interval) {
        interval = interval || 1500;
        setTimeout(function () {
          google.script.run
            .withSuccessHandler(handleActiveSheet)
            .withFailureHandler(showError)
            .cbRefreshIssueTable_getResetSidebar();
          poll();
        }, interval);
      }

      /**
       * @desc Show error message to user in form of an Alert.
       *       We do this only, every 5th error. Details are logged to users console.
       * @param {mixed} error
       */
      function showError(error) {
        if (error.hasOwnProperty('message')) {
          console.error('cbRefreshIssueTable_getResetSidebar caused [%s]; Info:%s', error.message, error);
        } else {
          console.error('cbRefreshIssueTable_getResetSidebar caused Error: %s', error);
        }

        if (++pollError == 5) {
          alert("Error in sidebar!\n\n" + error);
          pollError = 0;
        }
      }

      /*
       * each poll's response is compared to below 2 values, 
       * then we decide, if a sidebar refresh/reset is necessary
       */
      var currentActiveSheetId = null;
      var currentActiveCellValue = null;

      /**
       * @desc Handle poll response and react for sidebar changes.
       * @param {object} response    Response object {sheetId:<number>, currentActiveCellValue:<string>}
       * @return void
       */
      function handleActiveSheet(response) {
        if (currentActiveSheetId != response.sheetId || response.currentActiveCellValue != currentActiveCellValue) {
          // current active sheet changed OR the cell value/active cell changed
          currentActiveSheetId = response.sheetId;
          currentActiveCellValue = response.currentActiveCellValue;
          // call google and fetch updated sidebar content (reload)
          google.script.run
            .withSuccessHandler(onReloadSidebar)
            .cbRefreshIssueTable_initSidebar();
        }
      }
    </script>
</body>
</html>