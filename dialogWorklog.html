<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
    <style>
    .error-container { display: none; margin-bottom: 16px; padding: 5px 10px; text-align: center; color: #fff; }
    .is-loading { text-align: center; animation: blink .5s infinite; }
    @keyframes blink { 0% { color: #fff; } 50% { color: #777; } 100% { color: #fff; } }
    </style>
  </head>
  <body>
    ... loading anim ... (loading user/groups)
    <div id="response-message" class="error-container" role="dialog"></div>
    
    <form name="worklog" action="" method="post">
      <!-- to be hidden field --><input type="text" name="wlAuthorName" id="wlAuthorName" value="" />
      <label for="wlUser">
        <select name="wlUser" id="wlUser">
          <option value=""></option>
        </select>
      </label>
      OR
      <label for="wlGroup">
        <select name="wlGroup" id="wlGroup">
          <option value=""></option>
        </select>
      </label>

      <hr/>
      <label for="wlStartDate">
        <input type="text" name="wlStartDate" value="2017-07-20" />(datePicker)<br/>
      </label>
      <label for="wlEndDate">
        <input type="text" name="wlEndDate" value="2017-08-05" />(datePicker)<br/>
      </label>
      <hr/>

      <hr/>
      <div class="block">
        <button type="submit" class="action">View Report</button>
        <button type="button" onclick="google.script.host.close()">Cancel</button>
      </div>
    </form>
    
    <script>
      var frmWorklog  = document.forms['worklog'];
      var valid   = false;
      var timeout = null;
      var alert   = document.getElementById('response-message');
      var action  = frmWorklog.querySelector('[type=submit]');
      
      function onInitWorklog(response) {
        /* DEV */

        // gen user dropdown
        var sel = document.getElementById('wlUser');
        var fragment = document.createDocumentFragment();
        response.users.forEach(function(user, index) {
          var opt = document.createElement('option');
          opt.innerHTML = user.displayName;
          opt.value = user.name;
          fragment.appendChild(opt);
        });
        sel.appendChild(fragment);
        sel.onchange = function () {
          document.getElementById("wlAuthorName").value = this.options[this.selectedIndex].text;
        };
        
        // gen group dropdown
        sel = document.getElementById('wlGroup');
        fragment = document.createDocumentFragment();
        response.groups.forEach(function(group, index) {
          var opt = document.createElement('option');
          opt.innerHTML = group.name; //group.displayName;
          opt.value = group.name;
          fragment.appendChild(opt);
        });
        sel.appendChild(fragment);
        sel.onchange = function () {
          document.getElementById("wlAuthorName").value = this.options[this.selectedIndex].text;
        };
      }

      function formSubmitHandler(event) {
        if (event) event.preventDefault();

        //hideAlert();
        //if (!valid) return;
        //showAlert('fetch data ...', 1);

        var formData = {
          wlAuthorU: frmWorklog.wlUser.value,
          wlAuthorG: frmWorklog.wlGroup.value,
          wlStartDate: frmWorklog.wlStartDate.value,
          wlEndDate: frmWorklog.wlEndDate.value
        };
        
        google.script.run
          //.withSuccessHandler(onResponse)
          //.withFailureHandler(onResponse)
          .createWorklog(formData);

        // dont wait for response - bubble up all states not possible
        // instead,show loading animation for 2sec and then close dialog
        // success/error feedback handled inside sheet.
        google.script.host.close();
      }

      google.script.run
        .withSuccessHandler(onInitWorklog)
        .fetchUsersAndGroups(true);

      frmWorklog.addEventListener('submit', formSubmitHandler);
      //input.forEach(function(el){ el.addEventListener('change', inputValidatyHandler); });
      //window.addEventListener('load', );
    </script>
  </body>
</html>